<html>
<head>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min.js"></script>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <script type ="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQ45M31KyEIklPCbVKWuzwMLBvqtVSVM0"></script>
  <!-- full screen map -->
  <style type="text/css">
    html { height: 100%;}
    body {height :100%; margin:0; padding: 0;}
    #mapDiv {height:100%; right:0px; left:100px;}
    #userList {height:100%; width:100px; float:left; padding: 10px;}
  </style>
  <script type="text/javascript">
  // TODO: fix global variable
  var map;
  var geocoder = new google.maps.Geocoder();
  var markers = {};

  function initialize() {
      var mapOptions = {

        // start in USA
        center: new google.maps.LatLng(37.09024, -95.712891),
        zoom: 5
      };

      map = new google.maps.Map(document.getElementById("mapDiv"), mapOptions);

      map.addListener('click', function(e) {

        $.get("https://maps.googleapis.com/maps/api/geocode/json?latlng="+e.latLng.lat()+","+e.latLng.lng()+"&key=AIzaSyCXPMP0KsMOdfwehnmOUwu-W3VOK92CkwI", function(data) {
          console.log(data);
          var address = data.results[1].formatted_address

          // place marker
          var marker = new google.maps.Marker({
            map: map,

            // FIXME: address does not update after dropping marker
            draggable: true,
            position:data.results[0].geometry.location,
            animation: google.maps.Animation.DROP
          });
          var req = {

            // FIXME: server side is not receiving trip information
            // token: window.localStorage.getItem('com.tp'),
            destination: address,
          }
          console.log(address);
          $.ajax({
            method: 'POST',
            url:'http://127.0.0.1:3000/api/trips/create',
            dataType: 'json',
            data: req,
            success: function(res){
              console.log(res);
            }
            // contentType: 'json'
          })


            $('#userList').append($('<li>'+address+'</li>'))
          },'json');
        })
 
    }
    google.maps.event.addDomListener(window, 'load', initialize);

    // enable reverse look up from readable address to latLng
    function geocodeAddress() {
      var address = document.getElementById("address").value;
      geocoder.geocode({'address':address},
        function(results, status) {

          // TODO: remove redundant code with add event listener
          if(status === google.maps.GeocoderStatus.OK) {
            map.setCenter(results[0].geometry.location);
            var marker = new google.maps.Marker({
              map: map,
              position: results[0].geometry.location,
            });
            console.log(results)
            map.setZoom(6);
            map.panTo(marker.position)
          } else {
            console.log('error')
          }
        });
    }

    // TODO: finish removing marker
    // http://stackoverflow.com/questions/8521766/google-maps-api-3-remove-selected-marker-only
    function delMarker(id) {
      marker = markers[id];
      marker.setMap(null);
    }
  </script>
</head>
  <body>
    <input id="address" type="text" placeholder="Where is your trip?">
    <input type="button" value="Go" onclick ="geocodeAddress()"><br>
    <div id="userList">Your Trip Title</div>
    <div id="mapDiv"></div>
      <!-- <div id="regions_div" style="width: 900px; height: 500px;"></div> -->
  </body>
</html>